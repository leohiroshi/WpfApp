<UserControl x:Class="WpfApp.Views.PessoasView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Filtros de Pessoas -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <TextBlock Text="Nome:" VerticalAlignment="Center" Margin="0,0,6,0"/>
            <TextBox Width="180" Text="{Binding FiltroNome, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,10,0"/>
            <TextBlock Text="CPF:" VerticalAlignment="Center" Margin="0,0,6,0"/>
            <TextBox Width="150" Text="{Binding FiltroCpf, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,10,0"/>
            <Button Content="Buscar" Command="{Binding BuscarCommand}" />
            <Button Content="Recarregar" Command="{Binding CarregarCommand}" Margin="6,0,0,0"/>
        </StackPanel>

        <!-- Grid de Pessoas -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding Pessoas}"
                  SelectedItem="{Binding PessoaSelecionada}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Id" Binding="{Binding Id}" Width="60"/>
                <DataGridTextColumn Header="Nome" Binding="{Binding Nome}" Width="*"/>
                <DataGridTextColumn Header="CPF" Binding="{Binding Cpf}" Width="150"/>
                <DataGridTextColumn Header="Endereço" Binding="{Binding Endereco}" Width="2*"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Área de edição de Pessoa + Botão Incluir Pedido -->
        <GroupBox Grid.Row="2" Header="Edição de Pessoa" Margin="0,8,0,0">
            <Grid Margin="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Nome:" VerticalAlignment="Center"/>
                <TextBox Grid.Column="1" Text="{Binding EditBuffer.Nome, UpdateSourceTrigger=PropertyChanged}" Margin="6,0,12,0"/>

                <TextBlock Grid.Column="2" Text="CPF:" VerticalAlignment="Center"/>
                <TextBox Grid.Column="3" Text="{Binding EditBuffer.Cpf, UpdateSourceTrigger=PropertyChanged}" Margin="6,0,12,0"/>

                <TextBlock Grid.Column="0" Grid.Row="1" Text="Endereço:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                <TextBox Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="3" Margin="6,8,12,0"
                         Text="{Binding EditBuffer.Endereco, UpdateSourceTrigger=PropertyChanged}"/>

                <StackPanel Grid.Column="4" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Content="Incluir" Command="{Binding IncluirCommand}" Margin="0,0,6,0"/>
                    <Button Content="Editar" Command="{Binding EditarCommand}" Margin="0,0,6,0"/>
                    <Button Content="Salvar" Command="{Binding SalvarCommand}" Margin="0,0,6,0"/>
                    <Button Content="Excluir" Command="{Binding ExcluirCommand}" Margin="0,0,6,0"/>

                    <Separator Width="12"/>
                    <Button Content="Incluir Pedido"
                            Command="{Binding IncluirPedidoCommand}"
                            IsEnabled="{Binding PodeIncluirPedido}"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- Painel de inclusão de Pedido (inline) -->
        <GroupBox Grid.Row="3" Header="Inclusão de Pedido" Margin="0,8,0,0"
                  Visibility="{Binding IsIncluindoPedido, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Linha 1: Pessoa selecionada, Forma de Pagamento e Total -->
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Pessoa:" VerticalAlignment="Center"/>
                    <TextBlock Margin="6,0,12,0" VerticalAlignment="Center" FontWeight="Bold"
                               Text="{Binding PessoaSelecionada.Nome}"/>

                    <TextBlock Text="Forma de Pagamento:" VerticalAlignment="Center" Margin="12,0,6,0"/>
                    <ComboBox Width="180"
                              SelectedItem="{Binding FormaPagamentoSelecionada}">
                        <ComboBoxItem Content="Dinheiro"/>
                        <ComboBoxItem Content="Cartao"/>
                        <ComboBoxItem Content="Boleto"/>
                    </ComboBox>

                    <TextBlock Text="Total:" VerticalAlignment="Center" Margin="12,0,6,0"/>
                    <TextBlock FontWeight="Bold">
                        <TextBlock.Text>
                            <Binding Path="TotalPedidoEmEdicao" StringFormat="{}{0:C2}"/>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>

                <!-- Linha 2: Produtos e Itens -->
                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Margin="0,6,0,6">
                        <TextBlock Text="Produto:" VerticalAlignment="Center"/>
                        <ComboBox Width="250" Margin="6,0,12,0"
                                  ItemsSource="{Binding Produtos}"
                                  DisplayMemberPath="Nome"
                                  SelectedItem="{Binding ProdutoSelecionadoParaAdicionar}"/>

                        <TextBlock Text="Qtde:" VerticalAlignment="Center"/>
                        <TextBox Width="80" Margin="6,0,12,0"
                                 Text="{Binding QtdeParaAdicionar, UpdateSourceTrigger=PropertyChanged}"/>

                        <Button Content="Adicionar" Command="{Binding AdicionarItemPedidoCommand}" />
                        <Button Content="Remover" Command="{Binding RemoverItemPedidoCommand}" Margin="6,0,0,0"/>
                    </StackPanel>

                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding ItensPedidoEmEdicao}"
                              SelectedItem="{Binding ItemSelecionadoEmEdicao}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Produto" Binding="{Binding ProdutoNome}" Width="2*"/>
                            <DataGridTextColumn Header="Quantidade" Binding="{Binding Quantidade}" Width="120"/>
                            <DataGridTextColumn Header="Valor Unit." Width="140">
                                <DataGridTextColumn.Binding>
                                    <Binding Path="ValorUnitario" StringFormat="{}{0:C2}" />
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Subtotal" Width="140">
                                <DataGridTextColumn.Binding>
                                    <Binding Path="TotalItem" StringFormat="{}{0:C2}" />
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>

                <!-- Linha 3: Ações -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                    <Button Content="Finalizar Pedido" Command="{Binding FinalizarPedidoCommand}" Margin="0,0,6,0"/>
                    <Button Content="Cancelar" Command="{Binding CancelarInclusaoPedidoCommand}"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- Grid de Pedidos da Pessoa -->
        <GroupBox Grid.Row="4" Header="Pedidos da Pessoa" Margin="0,8,0,0">
            <Grid Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Filtros rápidos -->
                <StackPanel Orientation="Horizontal">
                    <CheckBox Content="Mostrar apenas entregues"
                              IsChecked="{Binding MostrarApenasRecebidos}" Margin="0,0,12,0"/>
                    <CheckBox Content="Mostrar apenas pagos"
                              IsChecked="{Binding MostrarApenasPagos}" Margin="0,0,12,0"/>
                    <CheckBox Content="Mostrar apenas pendentes de pagamento"
                              IsChecked="{Binding MostrarApenasPendentes}" />
                    <Button Content="Aplicar" Command="{Binding AplicarFiltrosPedidosCommand}" Margin="12,0,0,0"/>
                </StackPanel>

                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding PedidosDaPessoa}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Data da Venda" Width="170">
                            <DataGridTextColumn.Binding>
                                <Binding Path="DataVenda" StringFormat="{}{0:dd/MM/yyyy HH:mm}" />
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Valor Total" Width="140">
                            <DataGridTextColumn.Binding>
                                <Binding Path="ValorTotal" StringFormat="{}{0:C2}" />
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Forma de Pagamento" Binding="{Binding FormaPagamento}" Width="160"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="120"/>

                        <!-- Ações por linha -->
                        <DataGridTemplateColumn Header="Ações" Width="280">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                        <Button Content="Marcar como Pago" Margin="0,0,6,0"
                                                Command="{Binding DataContext.MarcarPagoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                        <Button Content="Marcar como Enviado" Margin="0,0,6,0"
                                                Command="{Binding DataContext.MarcarEnviadoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                        <Button Content="Marcar como Recebido"
                                                Command="{Binding DataContext.MarcarRecebidoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>
    </Grid>
</UserControl>